import "pe"
/*
This will flag legitimate files if they have both the winspool library and call the AddPrinterDriver* function.
The script also checks for pe imports.
Checked against the current powershell and python versions.
*/
rule nightmare
{
    meta:
        description = "Detection for PrintNightmare Vulnerability CVE-2021-1675"
        author = "Bartimus"
        reference = "https://github.com/bartimus-primed/printnm_yara"
    strings:
        $WinSpool = "winspool" nocase ascii wide
        $PrinterDriver1 = "AddPrinterDriverA" nocase ascii wide
        $PrinterDriver2 = "AddPrinterDriverExA" nocase ascii wide
        $PrinterDriver3 = "AddPrinterDriverExW" nocase ascii wide
        $PrinterDriver4 = "AddPrinterDriverW" nocase ascii wide
        $PrinterDriver5 = "AddPrinterDriver" nocase ascii wide
        $PrinterDriverREG = / *PrinterDriver* / nocase ascii wide
    condition:
        1 of ($P*) and $WinSpool
        or 1 of ($P*)
        or pe.imports("winspool.drv", "AddPrinterDriverA")
        or pe.imports("winspool.drv", "AddPrinterDriverExA")
        or pe.imports("winspool.drv", "AddPrinterDriverExW")
        or pe.imports("winspool.drv", "AddPrinterDriverW")
}